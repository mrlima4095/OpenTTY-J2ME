#!/bin/lua

local function joinpath(pwd)
    if string.sub(pwd, 1, 1) ~= "/" then
        return os.getcwd() .. pwd
    end
    return pwd
end

local function shell(args, enable, aliases, stdout, scope)
    local cmd, argument = string.getCommand(args), string.getArgument(args)
    args = string.split(argument, nil)

    if cmd == "" then

    elseif enable and aliases[cmd] then print(aliases[cmd]) return shell(aliases[cmd] .. " " .. argument, enable, aliases, stdout, scope)
    elseif io.open("/bin/" .. cmd) then
        local res = io.popen("/bin/" .. cmd, argument, true, stdout, scope)
        return res.status

    -- Kernel
    -- (Process)
    elseif cmd == "ps" then
        print("PID\tPROCESS")
        for k,v in pairs(os.getproc()) do
            print(k .. "\t" .. v)
        end
    -- (Permissions)
    elseif cmd == "su" then
        if os.getuid() == 0 then
            os.su(java.midlet.username)
        elseif argument == "" then
            print("su: usage: su [user] [passwd]")
        else
            local status = os.su("root", argument)

            if status == 0 then
                io.write("", stdout)
                print(string.env(io.read("/etc/motd")))
            elseif status == 13 then
                print("su: permission denied")
            end

            return status
        end

    -- Session
    -- (User Information)
    elseif cmd == "whoami" then print(os.getuid() == 0 and "root" or java.midlet.username)
    elseif cmd == "id" then print(os.getuid())
    -- (Manager)
    elseif cmd == "exit" then os.exit(nil)

    -- Window Aliases
    elseif cmd == "xterm" then graphics.display(graphics.db["xterm"])
    elseif cmd == "warn" then
        if #args < 2 then
        else
            graphics.display(graphics.new("alert", args[1], args[2]))
        end

    -- Shell Utils
    -- (Alias Manager)
    elseif cmd == "alias" then
        if argument == "" then for k,v in pairs(aliases) do print("alias " .. k .. "='" .. v .. "'") end
        elseif string.find(argument, "=") then
            local index = string.find(argument, "=")
            local alias, mean = string.sub(argument, 1, index - 1), string.sub(argument, index + 1)

            if alias ~= "" then aliases[alias] = mean end
        else
            for i = 1, #args do
                if aliases[args[i]] then print("alias " .. args[i] .. "='" .. aliases[args[i]] .. "'")
                else
                    print("alias: " .. args[i] .. ": not found")
                    return 127
                end
            end
        end
    elseif cmd == "unalias" then
        if argument == "" then
            print("unalias: usage: unalias [-a] name [name ...]")
        else
            for i = 1, #args do
                if aliases[args[i]] then
                    java.delete(aliases, args[i])
                else
                    print("unalias: " .. args[i] .. ": not found")
                    return 127
                end
            end
        end
    -- (Environment Keys)
    elseif cmd == "env" or cmd == "set" then
        if argument == "" then for k,v in pairs(os.getenv()) do print(k .. "=" .. v) end
        elseif string.find(argument, "=") then
            local index = string.find(argument, "=")
            local alias, mean = string.sub(argument, 1, index - 1), string.sub(argument, index + 1)

            if alias ~= "" then aliases[alias] = mean end
        else
            for i = 1, #args do
                if os.getenv(args[i]) then print(args[i] .. "=" .. os.getenv(args[i]))
                else
                    print(cmd .. ": " .. args[i] .. ": not found")
                    return 127
                end
            end
        end
    elseif cmd == "unset" then
        if argument == "" then
        else
            for i = 1, #args do
                os.setenv(args[i])
            end
        end


    elseif cmd == "eval" then if argument == "" then else print(shell(argument, true, aliases, stdout, scope)) end
    elseif cmd == "echo" then print(argument)
    elseif cmd == "clear" then graphics.SetText(io.stdout, "")

    -- File Utils
    elseif cmd == "pwd" then print(os.getcwd())
    elseif cmd == "cd" then
        if argument == "" then os.chdir("/home/")
        else
            argument = joinpath(argument)
            if string.sub(argument, -1, -1) ~= "/" then
                argument = argument .. "/"
            end

            local status = os.chdir(argument)
            if status == 127 then
                print("cd: " .. argument .. ": not found")
            elseif status == 20 then
                print("cd: " .. argument .. ": not a directory")
            elseif status == 1 then
                print("cd: no parent directory")
            end
            return status
        end
    elseif cmd == "cat" then
        for i = 1, #args do
            local fpwd = args[i]
            if string.find(fpwd, 1, 1) ~= "/" then
                fpwd = os.getcwd() .. fpwd
            end

            local ok, file = pcall(io.open, fpwd)
            if ok and file then
                print(string.env(io.read(file)))
            else
                print("cat: " .. args[i] .. ": not found")
                print(tostring(file))
                return 127
            end
        end
    elseif cmd == "ls" then
        local pwd
        if argument == "" or argument == "." then
            pwd = os.getcwd()
        else
            pwd = joinpath(argument)
        end

        local buff = ""
        for k,v in pairs(io.dirs()) do
            if string.sub(v, 1, 1) ~= "." then
                buff = buff .. "\t" .. v
            end
        end
        print(string.trim(buff))
    -- 
    elseif cmd == "buff" then graphics.SetText(io.stdin, argument)
    elseif cmd == "open" then
        if argument == "" then
        else
            local ok, status = pcall(os.open, argument)
            if not ok then
                if status == "javax.microedition.io.ConnectionNotFoundException" then print("open: " .. argument .. ": not found") return 127
                else print(tostring(status)) return 1 end
            end
        end

    else
        print(cmd .. ": not found")
        return 127
    end

    return 0
end

if arg[0] == "/bin/sh" then
    graphics.SetText(io.stdout, "")
    print(string.env(io.read("/etc/motd")))
end

return shell