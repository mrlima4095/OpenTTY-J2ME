#!/bin/lua

local version = "1.5"

local server = os.getenv("REPO") or "socket://opentty.xyz:31522"
local mirror = {
    ["armitage"] = { remote = "armitage", here = "/bin/armitage", description = "OpenTTY Network Tools" },
    ["autogc"] = { remote = "autogc", here = "/bin/autogc", description = "Auto Clean Memory" },
    ["bprev"] = { remote = "bprevious", here = "/lib/bprevious", description = "Back to Previous Screen" },
    ["cmatrix"] = { remote = "cmatrix", here = "/bin/cmatrix", description = "The Matrix Effect" },
    ["darkdm"] = { remote = "darkdm.lua", here = "/bin/ddm", description = "Reverse of LightDM" },
    ["docker"] = { remote = "docker.lua", here = "/bin/docker", description = "Conteiners on OpenTTY" },
    ["diff"] = { remote = "diff.lua", here = "/bin/diff", description = "View diferences of a file" },
    ["expr"] = { remote = "expr.lua", here = "/bin/expr", description = "Evaluate expressions" },
    ["forge"] = { remote = "forge", here = "/lib/forge", description = "Additional API for OpenTTY" },
    ["find"] = { remote = "find", here = "/bin/find", description = "" },
    ["grep"] = { remote = "grep", here = "/bin/grep", description = "" },
    ["hash"] = { remote = "hash.lua", here = "/bin/hash", description = "Prints file hash" },
    ["head"] = { remote = "head", here = "/bin/head", description = "Prints first lines of a file" },
    ["htop"] = { remote = "htop", here = "/bin/htop", description = "System Monitor" },
    ["jdb"] = { remote = "debuggers", here = "/bin/jdb", depends = { "forge" }, description = "Debugging API" },
    ["pastebin"] = { remote = "pastebin", here = "/bin/pastebin", description = "PasteBin Client for OpenTTY" },
    ["ping"] = { remote = "ping.lua", here = "/bin/ping", description = "Test connection delay" },
    ["sed"] = { remote = "sed.lua", here = "/bin/sed", description = "String Editor" },
    ["sdk"] = { remote = "sdkme", here = "/bin/sdk", description = "OpenTTY Application SDK" },
    ["sync"] = { remote = "sync", here = "/bin/sync", description = "OpenTTY Updater Checker" },
    ["tail"] = { remote = "tail", here = "/bin/tail", description = "Prints last lines of a file" },
    ["viaversion"] = { remote = "viaversion", here = "/bin/axrz", description = "Change OpenTTY API on Runtime" },
    ["webproxy"] = { remote = "proxy.lua", here = "/bin/shprxy", description = "Access OpenTTY on WebProxy" },
    ["wget"] = { remote = "wget", here = "/bin/wget", description = "Download files from Network" },
    ["wc"] = { remote = "wc", here = "/bin/wc", description = "Prints file lenght values" },
}

local function connect(payload)
    local ok, conn, i, o = pcall(socket.connect, server)
    if ok then
        ok = pcall(io.write, payload, o)
        if ok then
            local content = io.read(i, 8192)
            pcall(io.close, conn, i, o)
            return content
        end
    end
end

local function main()
    if arg[1] == nil or arg[1] == "help" then
        print("Yang Package Manager v" .. version)
        print("Usage: yang <command> [package]")
        print("Commands:")
        print("  install <package>  - Install a package")
        print("  remove <package>   - Remove a package")
        print("  update             - Check for updates")
        print("  list               - List available packages")
        print("  info <package>     - Show package information")
        print("  help               - Show this help")
    elseif arg[1] == "install" then
        if os.getuid() > 0 then
            print("Permission denied!")
            os.exit(13)
        end

        if arg[2] then
            if mirror[arg[2]] then
                local remote, here = mirror[arg[2]].remote, mirror[arg[2]].here
                print(":: Downloading " .. remote .. "...")
                local content = connect("get lib/" .. remote)
                if content then
                    local status = io.write(content, here)
                    if status == 0 then
                        print(":: Installed " .. here)
                    else
                        print(":: Installation error")
                        os.exit(1)
                    end
                else
                    print(":: Connection error")
                    os.exit(1)
                end
            else
                print("yang: install: " .. arg[2] .. ": not found")
                os.exit(127)
            end
        else
            print("Usage: yang install <package>")
        end
    elseif arg[1] == "remove" then
        if os.getuid() > 0 then
            print("Permission denied!")
            os.exit(13)
        end

        if arg[2] then
            if mirror[arg[2]] then
                local here = mirror[arg[2]].here
                local file = io.open(here)

                if file then
                    print(":: Removing " .. arg[2])
                    local status = os.execute("rm " .. here)
                    if status == 0 then
                        print(":: Removed " .. here .. "...")
                    else
                        print(":: Removing error")
                        os.exit(1)
                    end
                else
                    print(":: Package '" .. arg[2] .. "' not installed")
                    os.exit(2)
                end
            end
        else
            print("Usage: yang remove <package>")
        end
    elseif arg[1] == "update" then
        local response = connect("fetch")
        if response then
            print(":: " .. response)
        else
            print(":: Fetching error")
            os.exit(1)
        end
    elseif arg[1] == "list" then
        print("Available packages:")
        for name, info in pairs(mirror) do
            local status = ""
            local content = io.read(info.here)
            if content and content ~= "" then
                status = " [INSTALLED]"
            end
            print("- " .. name .. ": " .. info.description .. status)
        end
    elseif arg[1] == "info" then
        if #arg > 1 then
            local pkg = arg[2]
            if mirror[pkg] then
                local info = mirror[pkg]
                print("Package: " .. pkg)
                print("Description: " .. info.description)
                print("Install path: " .. info.here)
                print("Remote: " .. info.remote)

                if info.depends then
                    print("Dependencies: " .. table.concat(info.depends, ", "))
                end

                local content = io.read(info.here)
                if content and content ~= "" then
                    print("Status: Installed")
                else
                    print("Status: Not installed")
                end
            else
                print(":: Package " .. pkg .. " not found")
            end
        else
            print("Usage: yang info <package>")
        end
    else
        print("yang: " .. arg[1] .. ": not found")
        os.exit(127)
    end
end

os.setproc("name", "yang")
main()