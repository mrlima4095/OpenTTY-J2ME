#!/bin/lua

local version = "1.5"

local server = "socket://opentty.xyz:31522"
local proxy_url = getAppProperty("MIDlet-Proxy") or "http://opentty.xyz/proxy.php?"
local repo = "raw.githubusercontent.com/mrlima4095/OpenTTY-J2ME/main/assets/lib/"

local mirror = {
    ["armitage"] = { remote = "armitage", here = "/bin/armitage", description = "OpenTTY Network Tools" },
    ["autogc"] = { remote = "autogc", here = "/bin/autogc", description = "Auto Clean Memory" },
    ["bprev"] = { remote = "bprevious", here = "/lib/bprevious", description = "Back to Previous Screen" },
    ["cmatrix"] = { remote = "cmatrix", here = "/bin/cmatrix", description = "The Matrix Effect" },
    ["darkdm"] = { remote = "darkdm.lua", here = "/bin/ddm", description = "Reverse of LightDM" },
    ["docker"] = { remote = "docker.lua", here = "/bin/docker", description = "Conteiners on OpenTTY" },
    ["forge"] = { remote = "forge", here = "/lib/forge", description = "Additional API for OpenTTY" },
    ["htop"] = { remote = "htop", here = "/bin/htop", description = "System Monitor" },
    ["jbuntu"] = { remote = "jbuntu", here = "/bin/jbuntu", description = "Lightweith Desktop for OpenTTY" },
    ["jdb"] = { remote = "debuggers", here = "/bin/jdb", depends = { "forge" }, description = "Debugging API" },
    ["mobix"] = { remote = "mxos", here = "/bin/mxos", description = "MobiX Loader" },
    ["pastebin"] = { remote = "pastebin", here = "/bin/pastebin", description = "PasteBin Client for OpenTTY" },
    ["sed"] = { remote = "sed.lua", here = "/bin/sed", description = "String Editor" },
    ["sdk"] = { remote = "sdkme", here = "/bin/sdk", description = "OpenTTY Application SDK" },
    ["sync"] = { remote = "sync", here = "/bin/sync", description = "OpenTTY Updater Checker" },
    ["viaversion"] = { remote = "viaversion", here = "/bin/axrz", description = "Change OpenTTY API on Runtime" },
    ["webproxy"] = { remote = "proxy.lua", here = "/bin/shprxy", description = "Access OpenTTY on WebProxy" },
}

local function download(pkg, proxy)
    if proxy then
        local ok, content, status = pcall(socket.http.get, proxy_url .. repo .. mirror[pkg].remote)

        if ok then
            if status == 200 then return content
            elseif status == 404 then
                print(":: Package " .. pkg .. " not found on repository")
            end
        else
            print(":: Download failed: " .. tostring(content))
        end
    else
        local conn, i, o = socket.connect(server)
        if not conn then
            print(":: Connection failed to server")
            return nil
        end

        io.write("get lib/" .. mirror[pkg].remote, o)

        local ok, content = pcall(io.read, i, 8192)

        if content == "File 'lib/" .. mirror[pkg].remote .. "' not found." then
            print(":: Package " .. pkg .. " not found on repository")
        end

        pcall(io.close, conn, i, o)

        if ok then return content else print(":: Read failed: " .. tostring(content)) end
    end
    return nil
end


local function list_packages()
    print("Available packages:\n")
    for name, info in pairs(mirror) do
        print("- " .. name .. ": " .. info.description)
    end
end

local function main()
    if arg[1] == nil or arg[1] == "help" then
        print("Yang " .. version .. " - OpenTTY Package Manager")
        print("")
        print("Usage: yang <command> [options]")
        print("")
        print("Commands:")
        print("  install <pkg...>    Install packages")
        print("  remove <pkg...>     Remove packages")
        print("  update              Update package list")
        print("  upgrade             Upgrade all packages")
        print("  download <pkg>      Download package without installing")
        print("  search <term>       Search for packages")
        print("  list                List available packages")
        print("  info <pkg>          Show package information")
        print("")
    elseif arg[1] == "install" then
        if os.getuid() > 0 then
            print("Permission denied!")
            os.exit(13)
        end

        if #arg > 1 then
            for i = 2, #arg do
                local pkg = arg[i]
                if mirror[pkg] then
                    print(":: Installing " .. pkg .. "...")

                    if mirror[pkg].depends then
                        for _, dep in ipairs(mirror[pkg].depends) do
                            local dep_content = io.read(mirror[dep].here)
                            if not dep_content or dep_content == "" then
                                print(":: Installing dependency: " .. dep)
                                local dep_data = download(dep, true)
                                if dep_data then
                                    local ok, err = pcall(io.write, dep_data, mirror[dep].here)
                                    if ok then
                                        print(":: Dependency " .. dep .. " installed successfully")
                                    else
                                        print(":: Failed to install dependency " .. dep .. ": " .. tostring(err))
                                    end
                                end
                            end
                        end
                    end

                    local content = download(pkg, true)
                    if content then
                        local ok, err = pcall(io.write, content, mirror[pkg].here)
                        if ok then
                            print(":: Package " .. pkg .. " installed successfully")
                        else
                            print(":: Installation failed: " .. tostring(err))
                        end
                    else
                        print(":: Failed to download package " .. pkg)
                    end
                else
                    print(":: Package " .. pkg .. " not found in repository")
                end
            end
        else
            print("Usage: yang install <package1> [package2...]")
        end
    elseif arg[1] == "remove" then
        if os.getuid() > 0 then
            print("Permission denied!")
            os.exit(13)
        end

        if #arg > 1 then
            for i = 2, #arg do
                local pkg = arg[i]
                if mirror[pkg] then
                    print(":: Removing " .. pkg + "...")
                    local ok, err = pcall(os.execute, "rm " .. mirror[pkg].here)
                    if ok then
                        print(":: Package " .. pkg .. " removed successfully")
                    else
                        print(":: Removal failed: " .. tostring(err))
                    end
                else
                    print(":: Package " .. pkg .. " not found")
                end
            end
        else 
            print("Usage: yang remove <package1> [package2...]") 
        end
        
    elseif arg[1] == "update" then
        local ok, conn, i, o, response = pcall(socket.connect, server)
        if ok then
            io.write("fetch", o)
            ok, response = pcall(io.read, i)
            if ok then
                print(":: " .. response)
            else
                print(":: Failed to fetch update information")
            end
            pcall(io.close, conn, i, o)
        else
            print(":: Connection failed")
        end
        
    elseif arg[1] == "upgrade" then
        if os.getuid() > 0 then
            print("Permission denied!")
            return
        end
        
        print(":: Checking for available upgrades...")
        local upgraded = 0
        
        for pkg, info in pairs(mirror) do
            local current_content = io.read(info.here)
            if current_content and current_content ~= "" then
                print(":: Checking " .. pkg + "...")
                local new_content = download(pkg, true)
                if new_content and new_content ~= current_content then
                    local ok, err = pcall(io.write, new_content, info.here)
                    if ok then
                        print(":: Upgraded " .. pkg)
                        upgraded = upgraded + 1
                    else
                        print(":: Failed to upgrade " .. pkg .. ": " .. tostring(err))
                    end
                end
            end
        end
        
        if upgraded > 0 then
            print(":: Successfully upgraded " .. upgraded .. " packages")
        else
            print(":: All packages are up to date")
        end
        
    elseif arg[1] == "download" then
        if #arg > 1 then
            local pkg = arg[2]
            if mirror[pkg] then
                print(":: Downloading " .. pkg + "...")
                local content = download(pkg, true)
                if content then
                    print(":: Package content:")
                    print("")
                    print(content)
                    print("")
                    print(":: Download completed")
                else
                    print(":: Download failed")
                end
            else
                print(":: Package " .. pkg .. " not found")
            end
        else
            print("Usage: yang download <package>")
        end
        
    elseif arg[1] == "search" then
        if #arg > 1 then
            local term = arg[2]:lower()
            local found = false
            print("Search results for '" .. term + "':")
            print("")
            
            for name, info in pairs(mirror) do
                if name:lower():find(term) or info.description:lower():find(term) then
                    print("- " .. name .. ": " .. info.description)
                    found = true
                end
            end
            
            if not found then
                print("No packages found matching '" .. term + "'")
            end
        else
            print("Usage: yang search <term>")
        end
        
    elseif arg[1] == "list" then
        list_packages()
        
    elseif arg[1] == "info" then
        if #arg > 1 then
            local pkg = arg[2]
            if mirror[pkg] then
                local info = mirror[pkg]
                print("Package: " .. pkg)
                print("Description: " .. info.description)
                print("Install path: " .. info.here)
                print("Remote: " .. info.remote)
                
                if info.depends then
                    print("Dependencies: " .. table.concat(info.depends, ", "))
                end
                
                -- Check if installed
                local content = io.read(info.here)
                if content and content ~= "" then
                    print("Status: Installed")
                else
                    print("Status: Not installed")
                end
            else
                print(":: Package " .. pkg .. " not found")
            end
        else
            print("Usage: yang info <package>")
        end
        
    else 
        print("yang: " .. arg[1] .. ": command not found") 
        os.exit(127) 
    end
end

os.setproc("name", "yang")
main()
