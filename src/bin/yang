#!/bin/lua

local version = "1.5"

local server = os.getenv("REPO") or "socket://opentty.xyz:31522"
local mirror = {
    ["armitage"] = { remote = "armitage", here = "/bin/armitage", description = "OpenTTY Network Tools" },
    ["autogc"] = { remote = "autogc", here = "/bin/autogc", description = "Auto Clean Memory" },
    ["cmatrix"] = { remote = "cmatrix", here = "/bin/cmatrix", description = "The Matrix Effect" },
    ["curl"] = { remote = "curl.lua", here = "/bin/curl", description = "Connect with a Server" },
    ["docker"] = { remote = "docker.lua", here = "/bin/docker", description = "Conteiners on OpenTTY" },
    ["expr"] = { remote = "expr.lua", here = "/bin/expr", description = "Evaluate expressions" },
    ["forge"] = { remote = "forge", here = "/lib/forge", description = "Additional API for OpenTTY" },
    ["find"] = { remote = "find", here = "/bin/find", description = "" },
    ["grep"] = { remote = "grep", here = "/bin/grep", description = "" },
    ["hash"] = { remote = "hash.lua", here = "/bin/hash", description = "Prints file hash" },
    ["head"] = { remote = "head", here = "/bin/head", description = "Prints first lines of a file" },
    ["hostname"] = { remote = "hostname.lua", here = "/bin/hostname", description = "Manage Host Name" },
    ["htop"] = { remote = "htop", here = "/bin/htop", description = "System Monitor" },
    ["jauth2"] = { remote = "jauth2", here = "/lib/jauth2", description = "Credentials Manager" },
    ["jdb"] = { remote = "debuggers", here = "/bin/jdb", depends = { "forge" }, description = "Debugging API" },
    ["nano"] = { remote = "nano.lua", here = "/bin/nano", description = "Text Editor for OpenTTY" },
    ["pastebin"] = { remote = "pastebin", here = "/bin/pastebin", description = "PasteBin Client for OpenTTY" },
    ["ping"] = { remote = "ping.lua", here = "/bin/ping", description = "Test connection delay" },
    ["sed"] = { remote = "sed.lua", here = "/bin/sed", description = "String Editor" },
    ["sdk"] = { remote = "sdkme", here = "/bin/sdk", description = "OpenTTY Application SDK" },
    ["sync"] = { remote = "sync", here = "/bin/sync", description = "OpenTTY Updater Checker" },
    ["uname"] = { remote = "uname", here = "/bin/uname", description = "System Informations" },
    ["viaversion"] = { remote = "viaversion", here = "/bin/axrz", description = "Change OpenTTY API on Runtime" },
    ["webproxy"] = { remote = "proxy.lua", here = "/bin/shprxy", description = "Access OpenTTY on WebProxy" },
    ["wget"] = { remote = "wget", here = "/bin/wget", description = "Download files from Network" },

    ["net"] = { description = "Network Utilities", packages = { "curl", "hostname", "ping" } },
    ["file"] = { description = "File Utitlities", packages = { "find", "grep", "hash", "head", "nano", "sed" } }
}

local function connect(payload)
    return true
end

local function installed(pkg)
    if not mirror[pkg] or not mirror[pkg].here then
        return false
    end

    local content = io.read(mirror[pkg].here)
    return content and content ~= ""
end

local function install(pkg, verbose)
    if verbose then
        print(":: Installing " .. pkg .. "...")
    end

    local info = mirror[pkg]

    if info.depends then
        print(":: Building dependencies")
        for _, dep in ipairs(info.depends) do
            if not installed(dep) then
                install(pkg, verbose)
            end
        end
    end

    local content = connect("get lib/" .. info.remote)
    if content then
        local status = io.write(content, info.here)

        if verbose then
            if status == 0 then
                print(":: Installed " .. info.here)
            else
                print(":: Installation error for " .. pkg)
            end
        end

        return status == 0
    else
        if verbose then
            print(":: Connection error")
        end

        return nil
    end
end
local function remove(pkg, verbose)
    if verbose then
        print(":: Removing " .. pkg .. "...")
    end

    local info = mirror[pkg]

    if 
end

install() installed() remove()