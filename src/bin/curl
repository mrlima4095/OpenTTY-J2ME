#!/bin/lua

local libcore = require("libcore")

local output = "/dev/stdout"
local url, method, data = "", "GET", ""
local headers = {}

if not arg[1] then
    print("curl: usage: curl [options] [url]")
    os.exit(2)
end

os.setproc("name", "curl")

local i = 1
while i <= #arg - 1 do
    local opt = arg[i]

    if opt == "-h" or opt == "--help" then
    elseif opt == "-X" then
        i = i + 1
        method = arg[i] or "GET"
        method = string.upper(method)
    elseif opt == "-H" then
        i = i + 1
        local line = arg[i] or ""
        local colon = string.find(line, ":")
        if colon then
            headers[string.trim(string.sub(line, 1, colon - 1))] = string.trim(string.sub(line, colon + 1))
        end
    elseif opt == "-d" then
        i = i + 1
        data = arg[i] or ""
    elseif opt == "-o" then
        i = i + 1
        output = arg[i] or ""
    elseif string.sub(opt, 1, 1) == "-" then
        print("curl: option " .. opt .. ": is unknown")
        os.exit(2)
    else
        url = opt
    end
end

if url == "" then
    print("curl: no URL specified!")
    os.exit(2)
end

local ok, body, status = nil, nil, 0
if method == "GET" then
    ok, body, status = pcall(socket.http.get, url, headers)
elseif method == "POST" then
    ok, body, status = pcall(socket.http.post, url, data, headers)
else
    print("curl: method " .. method .. ": is unsupported")
    os.exit(127)
end

if not ok then
    print("curl: (6) Could not resolve host: " .. url)
    os.exit(101)
end

if output == "" then
    print(body)
else
    status = io.write(body, libcore.joinpath(output))

    if status == 13 then
        print("curl: " .. output .. ": permission denied")
    elseif status == 5 then
        print("curl: " .. output .. ": read-only storage")
    elseif status == 1 then
        print("curl: " .. output .. ": java.io.IOException")
    end
end