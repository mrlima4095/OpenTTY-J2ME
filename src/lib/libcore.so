#!/bin/lua

local libcore = {}

function libcore.joinpath(pwd)
    if pwd == nil or pwd == "" or pwd == "." then
        return os.getcwd()
    end

    local parts
    if string.sub(pwd, 1, 1) == "/" then
        parts = string.split(pwd, "/")
    else
        local cwd = os.getcwd()

        if string.sub(cwd, -1) == "/" and cwd ~= "/" then
            cwd = string.sub(cwd, 1, -2)
        end

        parts = string.split(cwd .. "/" .. pwd, "/")
    end

    local resolved = {}
    for i = 1, #parts do
        local part = parts[i]

        if part == "" or part == "." then
        elseif part == ".." then
            if #resolved > 0 then
                table.remove(resolved)
            end
        else
            table.insert(resolved, part)
        end
    end

    local result = "/" .. table.concat(resolved, "/")

    if #resolved == 0 then
        return "/"
    end

    if string.sub(result, 1, 2) == "//" then
        result = string.sub(result, 2)
    end

    return result
end

return libcore