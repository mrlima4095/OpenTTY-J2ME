#!/bin/lua

local app = {
    version = "1.2",
    proxy = "http://opentty.xyz/proxy.php?",
    mirror = "raw.githubusercontent.com/mrlima4095/OpenTTY-J2ME/main/assets/",
}

app.xwget = { title = "SmartME", message = "Downloading...", back = { root = function () graphics.display(graphics.Alert(app.xwget)) end }, indicator = true, }
app.xpkg = {
    title = "SmartME - Packages",
    back = { root = app.main },
    button = { label = "Install", root = app.install },
    fields = { "audio.lua", "httpd.lua", "math.lua", "string.lua" },
    type = "multiple"
}
app.xcfg = {
    title = "SmartME SDK",
    back = { root = os.exit },
    button = { label = "Select", root = function(opt) app.handler(opt) end },

    fields = { "Nano Editor", "---", "New", "Save", "File Explorer", "Build Project", "---", "Download Libraries", "Documentation", "About" }
}

function app.new()
    graphics.display(graphics.BuildList({
        title = "SmartME - New",
        back = { root = app.main },
        button = {
            label = "Create",
            root = function (option)
                os.execute("execute install /home/nano; touch;")

                if option == "Lua source code" then os.execute('add #!/bin/lua; add; add print("Hello, World!")') else os.execute('add [ Config ]; add name=My Package; add version=1.0; add description=About Package; add; add config=execute echo Hello, World!"') end

                os.execute("nano") os.exit()
            end
        },

        fields = { "Lua source code", "OpenTTY Package" }
    }))
end
function app.save() end
function app.dpkg() if app.pkg == nil then app.pkg = graphics.BuildList(app.xpkg) end graphics.display(app.pkg) end
function app.install(...)
    graphics.display(graphics.Alert(app.xwget))

    for k,pkg in pairs(...) do
        local content, status = socket.http.get(app.proxy .. app.mirror .. "lib/" .. pkg)

        if status == 200 then io.write(content, pkg)
        else
            graphics.display(graphics.Alert({ title = "SmartME", message = "Download failed!", back = { root = app.main } }))

            return
        end
    end

    graphics.display(graphics.Alert({ title = "SmartME", message = "Download complete!", back = { root = app.main } }))
end

function app.handler(option)
    if option == "Nano Editor" then os.execute("nano") os.exit()
    elseif option == "---" then app.main()
    elseif option == "New" then app.new()
    elseif option == "Save" then app.save()
    elseif option == "File Explorer" then os.execute("dir") os.exit()
    elseif option == "Build Project" then os.execute("lua") os.exit()
    elseif option == "Download Libraries" then app.dpkg()
    elseif option == "Documentation" then
        graphics.display(graphics.BuildScreen({
            title = "SmartME Docs",
            back = { root = app.main },
            fields = {
                "\tLua is a lightweight, high-level programming language designed for embedded use in applications. It was created in Brazil in the early 1990s by Roberto Ierusalimschy, Luiz Henrique de Figueiredo, and Waldemar Celes. Lua is known for its simple syntax, small size, and speed, making it ideal for use in game development, embedded systems, and applications that require a scripting language. It supports procedural programming, object-oriented programming, functional programming, and data-driven programming. One of Luaâ€™s key features is its ability to be easily integrated with other programming languages, especially C and C++, allowing developers to extend applications with custom functionality. Lua is widely used in game engines like Roblox, World of Warcraft, and Adobe Lightroom for scripting purposes.",
                { type = "item", label = "Lua docs", root = "open " .. app.proxy .. "www.lua.org/manual/5.4/" }
            }
        }))
    elseif option == "About" then
        graphics.display(graphics.Alert({
            title = "SmartME SDK",
            message = "SmartME " .. app.version,
            back = { root = app.main },
            button = {
                label = "Update",
                root = function()
                    local sdkme, status = socket.http.get(app.proxy .. app.mirror .. "lib/sdkme")

                    if string.hash(sdkme) == string.hash(io.read("/bin/sdk")) and status == 200 then
                        graphics.display(graphics.Alert({
                            title = "SmartME",
                            message = "SmartME is already updated!",
                            back = { root = function() app.handler("About") end }
                        }))
                    else
                        io.write(sdkme, "/home/sdkme")
                        graphics.display(graphics.Alert({
                            title = "SmartME",
                            message = "SmartME have been updated!",
                            back = {
                                label = "Reload",
                                root = function() os.execute("lua /bin/sdk") os.exit() end
                            }
                        }))
                    end
                end
            }
        }))
    end
end


function app.main()
    if app.menu == nil then app.menu = graphics.BuildList(app.xcfg) end

    graphics.display(app.menu)
end

os.setproc("name", "sdkme")
app.main()