--[[
    
[ Config ]

name=PasteBin
version=1.0
description=Paste Client 

include=/java/lib/settings

config=echo case !key (PASTEBIN_API) [ PasteBin ] To setup your API Key use 'pastebin api'
command=pastebin

pastebin=execute x11 quest pastebin;

shell.name=pastebin
shell.args=api,create

api=execute set VALUE=PASTEBIN_API; set LABEL=PasteBin API Key; cfg run; 
create=execute tick Creating Paste...; set OLD_QUERY=$QUERY; set QUERY=show; query socket://$REPO post https://pastebin.com/api/api_post.php api_dev_key=$PASTEBIN_API&api_option=paste&api_paste_code=$CONTENT; set OLD_TITLE=$TITLE; title Paste URL; tick; warn $OUTPUT; title $OLD_TITLE; set QUERY=$OLD_QUERY; unset OLD_TITLE; unset OLD_QUERY;


[ DISPLAY ]

quest.title=PasteBin
quest.label=Paste Content
quest.key=CONTENT
quest.cmd=execute pastebin create; unset CONTENT;

]]

local PASTEBIN_API = os.getenv("PASTEBIN_API")
local PROXY = os.getenv("REPO") or "opentty.xyz:31522"
local PROXY_HTTP = "http://opentty.xyz/proxy.php?"

local app = {}
function app.QuestAPI()
    graphics.display(graphics.BuildEdit({
        title = "PasteBin API Key",

        back = {
            label = "Back",
            root = os.exit
        },

        button = {
            label = "Confirm",
            root = function (key)
                os.execute("set PASTEBIN_API=" .. key)
                PASTEBIN_API = key

                app.main()
            end
        }
    }))
end
function app.PasteType()
    graphics.display(graphics.BuildList({
        title = "PasteBin",
        back = { root = os.exit },
        button = {
            label = "Select",
            root = function (sel)
                if sel == "Editor" then app.GetPaste() else app.GetFile() end
            end
        },

        fields = { "Upload File", "Editor", "---", "View" }
    }))
end

function app.GetURL()
    graphics.display(graphics.BuildQuest({
        title = "PasteBin",
        label = "Paste ID",
        back = { root = function() app.PasteType() end }
        button = {
            label = "Send",
            root = function(id)
                app.Download(id)
            end
        }
    }))
end
function app.SavePaste(content, screen)
    graphics.display(graphics.BuildQuest({
        title = "PasteBin",
        label = "File to Save",
        back = { root = function() graphics.display(graphics.BuildScreen(screen)) end }
        button = {
            label = "Save",
            root = function(file) io.write(content, file) end
        }
    }))
end
function app.Download(id)
    -- https://pastebin.com/raw/kTDNzLKj
    local content, status = socket.http.get(PROXY_HTTP .. "pastebin.com/raw/" .. id)
    
    if status == 404 then
        graphics.display(graphics.Alert({
            title = "PasteBin",
            message = "No Pastes found!",
            back = { root = function() app.GetURL() end }
        }))
    else 
        local screen = {
            title = "Paste - " .. id,
            back = { root = app.PasteType },
            button = { label = "Save" },
            fields = { content }
        }
        screen.button.root = function() app.SavePaste(content, screen) end
        graphics.display(graphics.BuildScreen(screen))
    end
end

function app.GetPaste()
    graphics.display(graphics.BuildEdit({
        title = "Paste Content",
        back = { root = app.PasteType },
        button = {
            label = "Create",
            root = function(c) app.paste(c) end
        }
    }))
end
function app.GetFile()
    graphics.display(graphics.BuildQuest({
        title = "PasteBin",
        label = "File to Send",
        back = { label = "Back", root = function() app.PasteType() end },
        button = {
            label = "Create",
            root = function (file)
                local content = io.read(file)

                if content == "" then
                    graphics.display(graphics.Alert({
                        title = "PasteBin",
                        message = "File '" .. file .. "' is empty!",
                        back = { label = "Back", root = function() app.GetFile() end }
                    }))
                else
                    app.paste(content)
                end
            end
        }
    }))
end

function app.paste(content)
    local conn, i, o = socket.connect("socket://" .. PROXY)
    local function replace(str, find, repl)
        local result = ""
        local i = 1
        while i <= #str do
            local c = str:sub(i,i)
            if c == find then
                result = result .. repl
            else
                result = result .. c
            end
            i = i + 1
        end
        return result
    end
    local function urlencode(str)
        if str == nil then return "" end
        str = replace(str, "%", "%%")   -- primeiro %
        str = replace(str, "\n", "%0A")
        str = replace(str, " ", "%20")
        str = replace(str, "&", "%26")
        str = replace(str, "=", "%3D")
        return str
    end


    
    io.write("post https://pastebin.com/api/api_post.php api_dev_key=" .. PASTEBIN_API .. "&api_option=paste&api_paste_code=" .. urlencode(content), o)
    local res = io.read(i)

    graphics.display(graphics.Alert({
        title = "PasteBin",
        message = res,
        back = { root = os.exit },
        button = { label = "Copy", root = function() print(res) os.exit() end }
    }))

    io.close(conn)
    io.close(i) io.close(o)
end
function app.main()
    os.setproc("name", "pastebin")
    
    if PASTEBIN_API == nil then app.QuestAPI() return end

    app.PasteType()
end

app.main()