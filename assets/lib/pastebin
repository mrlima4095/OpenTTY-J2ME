#!/bin/lua


function app.paste(content)
    local conn, i, o = socket.connect("socket://" .. PROXY)

    io.write("post https://pastebin.com/api/api_post.php api_dev_key=" .. PASTEBIN_API .. "&api_option=paste&api_paste_code=" .. content, o)
    local res = io.read(i)

    graphics.display(graphics.Alert({
        title = "PasteBin",
        message = res,
        back = { root = app.main },
        button = {
            label = "Copy",
            root = function () print(res) os.exit() end
        }
    }))

    pcall(io.close, conn, i, o)
end

function app.GetFile() graphics.display(graphics.BuildQuest({ title = "PasteBin", label = "File to Send", back = { label = "Back", root = app.main }, button = { label = "Upload", root = function (filename) local content = io.read(filename) if content == "" then graphics.display(graphics.Alert({ title = "PasteBin", message = "File '" .. filename .. "' is empty!", back = { label = "Back", root = app.GetFile } })) else app.paste(content) end end } })) end
function app.GetPaste() graphics.display(graphics.BuildEdit({ title = "Paste Content", back = { root = app.main }, button = { label = "Create", root = app.paste } })) end
function app.SaveFile(content, screen) graphics.display(graphics.BuildQuest({ title = "PasteBin", label = "File to Save", back = { root = function () graphics.display(graphics.BuildScreen(screen)) end }, button = { label = "Save", root = function (filename) io.write(content, filename) graphics.display(graphics.BuildScreen(screen)) end } })) end

function app.Preview(id)
    local content, status = socket.http.get(PROXY_HTTP .. "pastebin.com/raw/" .. id)

    if status == 404 then graphics.display(graphics.Alert({ title = "PasteBin", message = "No Pastes found!", back = { root = app.GetURL } }))
    else
        local screen = { title = "Paste - " .. id, back = { root = app.main }, button = { label = "Save" }, fields = { content } }

        screen.button.root = function () app.SaveFile(content, screen) end
        graphics.display(graphics.BuildScreen(screen))
    end
end
function app.GetURL() graphics.display(graphics.BuildQuest({ title = "PasteBin", label = "Paste ID", back = { root = app.main }, button = { label = "View", root = app.Preview } })) end

local PASTEBIN_API = os.getenv("PASTEBIN_API")
local PROXY = os.getenv("REPO") or "opentty.xyz:31522"
local PROXY_HTTP = "http://opentty.xyz/proxy.php?"

local app = {}

app.handler = function (opt)
    if option == "New Paste" then
    elseif option == "View Paste" then
    elseif option == "Config. PasteBin API KEY" then
    end
end

app.main = function ()
    local previous = graphics.getCurrent()
    local menu = graphics.new("list", "PasteBin")
    local back = graphics.new("command", { label = "Back", type = "back", priority = 1 })
    local select = graphics.new("command", { label = "Open", type = "ok", priority = 1 })

    if PASTEBIN_API then
        graphics.append(menu, "New Paste")
        graphics.append(menu, "View Paste")
    else
        graphics.append(menu, "Config. PasteBin API KEY")
        graphics.append(menu, "View Paste")
    end
    graphics.addCommand(menu, back)
    graphics.addCommand(menu, select)
    graphics.handler(menu, { [back] = function () graphics.display(previous) os.exit(0) end, [select] = app.handler, [graphics.fire] = app.handler })
    graphics.display(menu)
end

os.setproc("name", "pastebin")
app.main()