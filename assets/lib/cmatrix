#!/bin/lua

--[[

[ Config ]

name=cmatrix
version=1.0
description=Matrix Effect

api.version=1.17
api.error=execute echo [ Matrix Effect ] This program requires OpenTTY 1.17 (Lua Runtime)
api.match=minimum 
api.require=lua

]]

local collector = "execute unset CMATRIX; x11 stop; x11 init; case key (OLD_TITLE) exec title $OLD_TITLE & unset OLD_TITLE; clear; true"
local function cmatrix()
    if os.getenv("J2EMU") ~= nil then error("cmatrix cannot run in j2me loader!") end

    local thr = os.execute("case thread (MIDlet) false")
    if tonumber(thr) == 255 then return os.execute("bg lua " .. arg[0]) end

    os.execute("execute set OLD_TITLE=$TITLE; export CMATRIX; x11 stop; title hide; x11 xfinit stdout; clear; bg cron 20 unset CMATRIX; true")

    while os.getenv("CMATRIX") do

        io.write(math.random(10) .. " ", "/dev/stdout", "a")

        if string.len(io.read()) > 200 then os.execute("clear") end
    end

    os.execute(collector)
end

os.setproc("name", "cmatrix")
os.setproc("collector", collector)
cmatrix()