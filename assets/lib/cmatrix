#!/bin/lua

--[[

[ Config ]

name=cmatrix
version=1.0
description=Matrix Effect

api.version=1.16
api.error=execute echo [ Matrix Effect ] This program requires OpenTTY 1.16 (Lua Runtime)
api.match=minimum 
api.require=lua

config=execute alias cmatrix=bg lua /home/cmatrix; cmatrix

]]

local collector = "execute x11 stop; x11 init; title $OLD_TITLE; clear;"
local function cmatrix()
    if os.getenv("J2EMU") ~= nil then error("cmatrix cannot run in j2me loader!") end

    local thr = os.execute("case thread (MIDlet) false")
    if tonumber(thr) == 255 then return os.execute("bg lua " .. arg[0]) end

    os.execute("execute set OLD_TITLE=$TITLE; export CMATRIX; x11 stop; title hide; x11 xfinit stdout; clear; bg cron 20 unset CMATRIX; true")

    while os.getenv("CMATRIX") do

        io.write(random(10) .. " ", "/dev/stdout", "a")

        if string.len(io.read()) > 200 then os.execute("clear") end
    end

    os.execute()
end

os.setproc("name", "cmatrix")
os.setproc("collector", "execute unset CMATRIX; " .. collector)
cmatrix()